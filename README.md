<div dir="rtl">

# FarnaTask

## توضیحات راجب تسک:

این تسک خواسته شده توسط شرکت Farna روی پروژه [نمونه‌کار](https://github.com/AbolfazlFa7/Shop_Portfolio) خودم خواسته شده و طبق درخواست، لازم بود قابلیت «فروش ویژه» به سیستم اضافه شود.  
برای اضافه کردن این قابلیت، بخش‌های مختلف پروژه مثل مدل‌ها، قیمت‌گذاری، سبد خرید و سفارش و غیره دچار تغییر و توسعه شده‌اند.

---

### ایجاد مدل `FlashSale`

-   فیلدهای شامل:
    -   `title`
    -   `start_time`
    -   `end_time`
    -   رابطه‌ی **ManyToMany** با مدل `Product` (از طریق مدل واسط)
-   توضیحات:
    -   این مدل نمایان‌گر یک رویداد فروش ویژه است که در بازه‌ی مشخصی فعال می‌شود.

---

### ایجاد مدل واسط `FlashSaleProduct`

-   فیلدهای شامل:
    -   `flash_sale`
    -   `product`
    -   `discount_percent`
    -   `discount_amount`
    -   `limited_stock`
-   توضیحات:
    -   این مدل واسط برای مدیریت تخفیف‌های قابل اعمال روی محصولات است.
    -   تنها یکی از دو مقدار `discount_percent` یا `discount_amount` باید مقداردهی شود.
    -   فیلد `limited_stock` تعداد قابل فروش محصول در این فروش ویژه را مشخص می‌کند.

---

### منطق قیمت‌گذاری

-   قیمت نهایی محصول در صورت وجود فروش ویژه‌ی فعال **بر اساس FlashSaleProduct محاسبه می‌شود**.
-   اولویت قیمت‌ها:
    -   قیمت FlashSale ← سپس قیمت استاندارد محصول.
-   این منطق در بخش‌های باید اعمال شود:
    -   نمایش جزئیات محصول
    -   سبد خرید
    -   نهایی‌سازی سفارش

---

### بهینه‌سازی کوئری‌ها

-   برای واکشی اطلاعات فروش ویژه‌ی فعال از:
    -   `select_related`
    -   `prefetch_related`  
        استفاده شده تا از ایجاد N+1 Query جلوگیری شود.

---

### ایجاد Endpoint جدید

-   ایجاد یک API فقط خواندنی:
    -   مسیر: `/api/flash-sales/`
-   این Endpoint:
    -   لیست فروش‌های ویژه فعال را برمی‌گرداند.
    -   محصولات هر FlashSale با تخفیف مربوط به همان رویداد نمایش داده می‌شوند.

---

### یکپارچه‌سازی با سبد خرید و سفارش

-   محدودیت‌ها:
    -   کاربر نمی‌تواند بیشتر از `limited_stock` یک محصول را به سبد اضافه کند.
    -   همچنین موجودی واقعی محصول نیز بررسی می‌شود.
-   در زمان ثبت سفارش:
    -   قیمت نهایی (بعد از اعمال تخفیف FlashSale) ذخیره می‌شود.
    -   مقدار `limited_stock` کاهش پیدا می‌کند.

---

### تعامل با سیستم کوپن

-   تصمیم‌گیری درباره‌ی این‌که آیا کوپن و FlashSale قابل جمع هستند یا نه.

---

### بخش ادمین

-   مدل‌های زیر در Admin باید ثبت شوند:
    -   `FlashSale`
    -   `FlashSaleProduct`
-   امکانات:
    -   ایجاد، ویرایش و مدیریت فروش‌های ویژه
    -   مدیریت تخفیف‌ها و موجودی محدود

---

## تغییرات انجام شده:

### FlashSale & FlashSaleProduct

مدل `FlashSale` , `FlashSaleProduct` دقیقا همونجور که خواسته شده بود ساخته شده, ولی با یکسری تغیرات جزئی:

-   در مدل `FlashSaleProduct` بجای تعریف یک فیلد برای مقدار درصد و یک فیلد برای مقدار واحدی و بعد یونیک کردن این دوتا نسبت به هم, از `discount_type` و `discount_value` استفاده شده.

    -   دلیل این انتخاب: - چون در کل پروژم و مدل های دیگر از همین روش استفاده کرده بودم, و برای یکدست بودن پروژه, این مدل رو هم مثل اونا نوشتم.
        <br>

-   در مدل `FlashSale` بجای تعریف یک `ManyToManyField` و استفاده از `through` برای واسط کردن جدول `FlashSaleProduct` به این مدل و مدل `Product`, از روشی بهینه تر و بهتر استفاده شده. - در مدل `FlashSaleProduct` دو فیلد برای شبیه سازی این عمل انجام شده: - `flash_sale` : یک فیلد `ForeignKey` به مدل `FlashSale` است. - `product` : یک فیلد `ForeignKey` به مدل `Product` است. - دلیل انجام این عمل: - مدل `FlashSaleProduct` فقط یک جدول واسط ساده نبود و منطق تجاری مستقل داشت؛ از جمله نگهداری مقدار تخفیف، نوع تخفیف و محدودیت موجودی هر محصول در فروش ویژه. - استفاده از `ManyToManyField` با `through` برای چنین حالتی باعث افزایش پیچیدگی می‌شد و کنترل‌پذیری روی عملیات تجاری (مثل اعتبارسنجی، کاهش موجودی، یا محاسبه قیمت نهایی) را کاهش می‌داد. - تعریف رابطه با دو `ForeignKey` معماری شفاف‌تر، قابل توسعه‌تر و قابل تست‌تری ایجاد می‌کند و مدیریت این بخش در پنل ادمین را نیز ساده‌تر و قابل فهم‌تر می‌سازد. - خلاصه کلام:
    این روش از نظر performance با ManyToMany تفاوتی ندارد،
    اما به دلیل وجود منطق تجاری مستقل در FlashSaleProduct،
    استفاده از ForeignKeyها معماری شفاف‌تر، انعطاف‌پذیرتر و قابل نگه‌داری‌تری ایجاد می‌کند.

---

### منطق قیمت‌گذاری

<br>

#### Product

1. در مدل `Product` متودی نوشته شده برای گرفتن قیمت حال محصول, که بررسی میکند آیا در فروش ویژه وجود فعالی وجود دارد یا خیر. ( با چک کردن زمان شروع و پایان فروش ویژه)
2. باید در دو API که یکی مسؤل نشان دادن جزئیات یک محصول و دیگری مسؤل نشان دادن لیستی از محصولات به کاربر هستند, قیمت نهایی محصولات اگر در فروش ویژه هستند نمایش داده شود.

<br>

##### Product Detail:

در سریالایزر از متودی که برای `Product` تعریف کردیم برای دریافت قیمت نهایی محصول و نشان دادن آن در فیلدی به نام `final_price` استفاده شده است.

##### Product List:

اینجا دیگه استفاده از متودی که برای `Product` تعریف کردیم عاقلانه نیست, جون باعث `N+1 query` میشه.
پس بهتره خود `QuerySet`ی که میزنیم رو تغییر بدیم.

با تغییر دادنش و استفاده از `annotate` میتونیم بجای گرفتن نتیجه با `N+1 query`, با فقط 5 کوئری نتیجه بگیریم! (تست شده)

<br>

#### Cart

ما 3 بخش از سبد خرید رو باید تغییر بدیم

1. لیست سبد خرید
    - برای نشان دادن `final_price` روی هر محصول
2. اضافه کردن کردن به سبد خرید
    - برای `validate` کردن تعداد محصول انتخابی توسط کاربر, که محصولات `FlashSale` رو بیشتر از یکی نتونه انتخاب کنه
3. آپدیت کردن سبد خرید
    - اگه کاربر یک محصول فروش ویژه تو سبد خریدش هست, نتونه یکی بیشتر کنه, مثلا بشه 2 تا

##### Cart List:

از همون متودی که برای گرفتن `final_price` برای مدل `Product` تعریف کردیم استفاده میکنیم

##### Cart Item Create & Cart Item Update:

در `serializers.py` برای `CartItemsCreateSerializer` قسمت `validate` متود , بخشی اضافه کردم, که بررسی کنه اگه محصول تو فروش ویژه بود نزار کاربر بیشتر از یکی انتخاب کنه

<br>

#### Coupon

در قسمت `coupon_service` بخشی اضافه شد که بررسی میکند اگر حتی یکی از محصولات موجود در سبد خرید کاربر, در فروش ویژه بوده, اجازه اعمال تخفیف روی آن سبد خرید داده نشود.

دلیل این انتخابم که اگه فروش ویژه روی محصول فعال بود اجازه اعمال تخفیف داده نشه اینه که, تا جایی که من دیدم فروشگاه های بزرگ همچین کاری می کنن

<br>

#### Order

در این قسمت هم , هم کوپن رو بررسی میکنه هم فروش ویژه, که اگه فروش ویژه تو سبد خرید باشه اجازه کد کوپن داده نمیشه.
و همچنین فروش تخفیف های اعمال شده توسط فروش ویژه روی محصول رو بررسی میکنه, و اگه اوکی بود قیمت نهایی و مقدار تخفیف و فیلد های دیگر رو در مدل `Order` ذخیره میشه.

و سر آخر که `payment` با موفقیت انجام شد و `Order` به `paid` تغییر کرد, یکی از `limitted_stock` محصولاتی که تو فروش ویژه بودن رو کم میکنه.

---

### بهینه سازی کوئری ها

در قسمت هایی که تغیراتی برای اضافه کردن فیچر فروش ویژه اعمال شده, کوئری ها هم بهینه شدند از جمله بررسی در فروش ویژه بودن محصول در `coupon_service`.

---

### ایجاد API Endpoint

یک API برای مدل `FlashSale` تعریف شده که به فقط با متود `GET` قابل دسترسی هست.

این API لیستی از تمام `FlashSale` های فعال نشان میدهد که که تخفیف ها همراه با محصولات را کامل نشان میدهد

اگر به این اند پوینت رکوئست بزنید `/api/p/flash_sale/`:

همچین خروجی به عنوان مثال میگیرید:

```json
{
    "count": 1,
    "next": null,
    "previous": null,
    "results": [
        {
            "id": 2,
            "title": "yalda",
            "start_time": "2025-11-13T14:36:32+03:30",
            "end_time": "2025-11-26T13:24:46+03:30",
            "items": [
                {
                    "id": 1,
                    "discount_type": "percent",
                    "discount_value": 20,
                    "limited_stock": 2,
                    "product": {
                        "id": 1,
                        "name": "Enterprise-wide 24hour frame",
                        "slug": "enterprise-wide-24hour-frame",
                        "sku": "PRD-2025-00000",
                        "description": "Involve just result identify actually woman. Threat hold or garden but bar tree executive. Agency nearly training. Resource theory arm much executive. Easy someone painting manage growth gun particularly. How lose suddenly movie.",
                        "price": 186260000,
                        "stock": 16,
                        "is_available": true,
                        "created_at": "2025-11-13T14:08:55.628941+03:30",
                        "updated_at": "2025-11-13T14:08:55.629005+03:30",
                        "category": 5
                    }
                },
                {
                    "id": 2,
                    "discount_type": "percent",
                    "discount_value": 50,
                    "limited_stock": 1,
                    "product": {
                        "id": 2,
                        "name": "Quality-focused foreground hierarchy",
                        "slug": "quality-focused-foreground-hierarchy",
                        "sku": "PRD-2025-00001",
                        "description": "Speak phone across pick pretty answer. Thing career first. Economy continue most recognize girl. Six adult politics center church against movement.",
                        "price": 116060000,
                        "stock": 15,
                        "is_available": true,
                        "created_at": "2025-11-13T14:08:55.629048+03:30",
                        "updated_at": "2025-11-13T14:08:55.629071+03:30",
                        "category": 9
                    }
                }
            ]
        }
    ]
}
```

---

### Admin Panel for FlashSale

مدل‌های `FlashSale` و `FlashSaleProduct` در پنل ادمین Django ثبت شده‌اند تا مدیران بتوانند به راحتی فروش‌های ویژه را مدیریت کنند.

#### مدیریت FlashSale

-   **نمایش در لیست**:
    -   عنوان فروش (`title`)
    -   زمان شروع (`start_time`)
    -   زمان پایان (`end_time`)
-   **قابلیت‌ها**:
    -   ایجاد، ویرایش و حذف رویدادهای فروش ویژه
    -   افزودن محصولات به فروش ویژه از طریق **اینلاین** (`FlashSaleProductInline`)
        -   فیلدهای قابل تنظیم: محصول، نوع تخفیف، مقدار تخفیف، موجودی محدود
-   **فیلتر و جستجو**:
    -   فیلتر بر اساس بازه زمانی (شروع/پایان)
    -   جستجوی سریع بر اساس عنوان

#### مدیریت FlashSaleProduct

-   **نمایش در لیست**:
    -   فروش ویژه مرتبط (`flash_sale`)
    -   محصول (`product`)
    -   نوع تخفیف (`discount_type`)
    -   مقدار تخفیف (`discount_value`)
    -   موجودی محدود (`limited_stock`)
-   **قابلیت‌ها**:
    -   ویرایش مستقیم تخفیف و موجودی محدود
    -   استفاده از **autocomplete** برای انتخاب سریع `flash_sale` و `product`
    -   اعتبارسنجی خودکار:
        -   درصد تخفیف باید بین ۰ تا ۱۰۰ باشد
        -   موجودی محدود باید عدد مثبت باشد
-   **اینلاین در پنل Product**:
    -   نمایش فروش‌های ویژه فعال برای هر محصول در صفحه ویرایش محصول

#### بهینه‌سازی و تجربه کاربری

-   استفاده از `autocomplete_fields` برای جلوگیری از لود کند در انتخاب محصول/فروش
-   پیش‌نمایش قیمت نهایی (با تخفیف) در پنل محصول
-   اکشن‌های سفارشی برای فعال/غیرفعال کردن سریع فروش‌های ویژه

این ساختار پنل ادمین را **کارآمد، شفاف و قابل نگهداری** می‌کند و نیازی به دخالت توسعه‌دهنده برای مدیریت روزانه فروش‌های ویژه نیست.

---

<div dir="ltr">

Author: Abolfazl Fallahker
email: [AbolfazlFallahkar8080@gmail.com](mailto:AbolfazlFallahkar8080@gmail.com)
telegram: @AbolfazlFa7
Resume WebSite: [abolfazlfa7.vercel.app/](https://abolfazlfa7.vercel.app/)

</div>

</div>
